<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELECCI√ìN DE ELEMENTOS DEL DOM ---
        const catalog = document.getElementById('catalog');
        const categoryFilters = document.getElementById('categoryFilters');
        const productDetailModal = document.getElementById('productDetailModal');
        const productDetailContent = document.getElementById('productDetailContent');
        const cartFloat = document.getElementById('openCart');
        const cartCount = document.getElementById('cartCount');
        const cartModal = document.getElementById('cartModal');
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        const openCart = document.getElementById('openCart');
        const closeCart = document.getElementById('closeCart');
        const orderWhats = document.getElementById('orderWhats');
        const searchBar = document.getElementById('searchBar');
        const featuredSection = document.getElementById('featuredSection');
        const notificationsBtn = document.getElementById('notificationsBtn');
        let cart = [];

        const money = val => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // --- BASE DE DATOS DE PRODUCTOS ---
        const products = [
             {id: 1, name: 'Picanha na Chapa', price: 89.90, desc: 'Picanha fatiada com mandioca cozida na manteiga de garrafa e vinagrete.', category: 'Pratos', img: 'https://images.pexels.com/photos/853005/pexels-photo-853005.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', options: { protein: ['Carne Bovina', 'Carne de Sol'], cutlery: true }, featured: true},
             {id: 23, name: 'Combo Fam√≠lia', price: 159.90, desc: '1 Frango Assado Inteiro + 1 Por√ß√£o de Arroz + 1 Por√ß√£o de Maionese + 1 Guaran√° 2L.', category: 'Combos', img: 'https://images.pexels.com/photos/6210876/pexels-photo-6210876.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', isCombo: true, featured: true },
             {id: 4, name: 'Strogonoff', price: 45.50, desc: 'Cremoso strogonoff com cogumelos, acompanha arroz branco e batata palha.', category: 'Pratos', img: 'https://images.pexels.com/photos/13523293/pexels-photo-13523293.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', options: { protein: ['Frango', 'Fil√© Mignon'], cutlery: true }},
             {id: 22, name: 'Combo Casal', price: 99.90, desc: '1 Picanha na Chapa (escolha a carne) + 1 Por√ß√£o de Fritas com Cheddar e Bacon + 2 Guaran√°s Lata.', category: 'Combos', img: 'https://images.pexels.com/photos/1640773/pexels-photo-1640773.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', isCombo: true },
             {id: 2, name: 'Feijoada Completa', price: 59.90, desc: 'Acompanha arroz, couve, farofa, torresmo e laranja. Servida √†s quartas e s√°bados.', category: 'Pratos', img: 'https://images.pexels.com/photos/9940428/pexels-photo-9940428.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1'},
             {id: 3, name: 'Moqueca de Peixe', price: 79.90, desc: 'Deliciosa moqueca com peixe branco, piment√µes, tomate, leite de coco e azeite de dend√™. Acompanha arroz e pir√£o.', category: 'Pratos', img: 'https://images.pexels.com/photos/8993888/pexels-photo-8993888.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', options: { cutlery: true }},
             {id: 5, name: 'Parmegiana de Mignon', price: 65.00, desc: 'Bife de fil√© mignon √† parmegiana com muito queijo, acompanha arroz e fritas.', category: 'Pratos', img: 'https://images.pexels.com/photos/10398075/pexels-photo-10398075.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', options: { cutlery: true }},
             {id: 6, name: 'Fritas com Cheddar e Bacon', price: 35.90, desc: 'Por√ß√£o generosa de batatas fritas crocantes com cheddar cremoso e bacon em cubos.', category: 'Por√ß√µes', img: 'https://images.pexels.com/photos/115740/pexels-photo-115740.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1'},
             {id: 7, name: 'An√©is de Cebola', price: 29.90, desc: 'An√©is de cebola empanados e crocantes, acompanha molho barbecue da casa.', category: 'Por√ß√µes', img: 'https://images.pexels.com/photos/4106411/pexels-photo-4106411.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1'},
             {id: 11, name: 'Pudim de Leite', price: 15.00, desc: 'Cl√°ssico pudim de leite condensado com calda de caramelo, cremoso e irresist√≠vel.', category: 'Sobremesas', img: 'https://images.pexels.com/photos/4694293/pexels-photo-4694293.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1'},
             {id: 17, name: 'Guaran√° Antarctica (Lata)', price: 7.00, desc: 'O refrigerante com o sabor original do Brasil.', category: 'Bebidas', img: 'https://images.pexels.com/photos/1301373/pexels-photo-1301373.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1'}
        ];

        // --- FUNCIONES DE RENDERIZADO Y L√ìGICA ---

        function renderFeatured() {
            const featuredProducts = products.filter(p => p.featured);
            if (featuredProducts.length === 0) return;

            featuredSection.innerHTML = `<h2 class="featured-title">‚≠ê Sugest√µes do Chef ‚≠ê</h2>`;
            featuredProducts.forEach(p => {
                const el = document.createElement('div');
                el.className = 'featured-card';
                el.dataset.details = p.id;
                el.innerHTML = `
                    <img src="${p.img}" alt="${p.name}" class="card-img">
                    <div class="card-body">
                        <h3 class="card-title">${p.name}</h3>
                        <p class="card-desc">${p.desc}</p>
                        <span class="price">${p.isCombo ? 'Combo por' : ''} ${money(p.price)}</span>
                    </div>`;
                featuredSection.appendChild(el);
            });
        }
        
        // ** ESTA ES LA FUNCI√ìN QUE FALTABA **
        function renderCategories() {
            const categories = ['Todos', ...new Set(products.map(p => p.category))];
            categoryFilters.innerHTML = '';
            categories.forEach(category => {
                if (!category) return;
                const btn = document.createElement('button');
                btn.dataset.category = category.toLowerCase();
                btn.textContent = category;
                categoryFilters.appendChild(btn);
            });
        }

        function renderCatalog(searchTerm = '', categoryFilter = 'todos') {
            catalog.innerHTML = '';
            const searchLower = searchTerm.toLowerCase();
            
            let filteredProducts = products.filter(p => {
                const matchesCategory = categoryFilter === 'todos' || p.category.toLowerCase() === categoryFilter;
                const matchesSearch = p.name.toLowerCase().includes(searchLower) || p.desc.toLowerCase().includes(searchLower);
                return matchesCategory && matchesSearch;
            });

            if (categoryFilter === 'todos' && searchTerm === '') {
                const categories = [...new Set(products.map(p => p.category))];
                categories.forEach(category => {
                    if (!category) return;
                    catalog.innerHTML += `<h2 class="category-title">${category}</h2>`;
                    const productRow = document.createElement('div');
                    productRow.className = 'product-row';
                    products.filter(p => p.category === category).forEach(p => {
                        productRow.appendChild(createProductCard(p));
                    });
                    catalog.appendChild(productRow);
                });
            } else {
                const catalogGrid = document.createElement('div');
                catalogGrid.className = 'catalog-grid';
                filteredProducts.forEach(p => {
                    catalogGrid.appendChild(createProductCard(p));
                });
                catalog.appendChild(catalogGrid);
            }
            addCardEventListeners();
        }

        function createProductCard(p) {
            const el = document.createElement('div');
            el.className = 'card';
            el.dataset.details = p.id;
            el.innerHTML = `
                <img src="${p.img}" alt="${p.name}" class="card-img">
                <div class="card-body">
                    <h3 class="card-title">${p.name}</h3>
                    <p class="card-desc">${p.desc}</p>
                </div>
                <div class="card-footer">
                    <span class="price">${money(p.price)}</span>
                    <button class="ghost">${p.options || p.isCombo ? 'Ver Op√ß√µes' : 'Adicionar'}</button>
                </div>`;
            return el;
        }

        function showProductDetail(id) {
            const p = products.find(x => x.id == id);
            let optionsHtml = '';
            if (p.options) {
                optionsHtml += '<form id="productOptionsForm" class="options-form">';
                if (p.options.protein) {
                    optionsHtml += '<h3>Escolha a Prote√≠na</h3><div class="radio-group">';
                    p.options.protein.forEach((item, index) => {
                        optionsHtml += `<input type="radio" id="protein_${index}" name="protein" value="${item}" ${index === 0 ? 'checked' : ''}><label for="protein_${index}">${item}</label>`;
                    });
                    optionsHtml += '</div>';
                }
                if (p.options.cutlery) {
                    optionsHtml += '<h3>Precisa de talheres?</h3><div class="radio-group">';
                    optionsHtml += `<input type="radio" id="cutlery_yes" name="cutlery" value="Sim" checked><label for="cutlery_yes">Sim</label><input type="radio" id="cutlery_no" name="cutlery" value="N√£o"><label for="cutlery_no">N√£o</label>`;
                    optionsHtml += '</div>';
                }
                optionsHtml += '<h3>Observa√ß√µes</h3><textarea id="observations" placeholder="Ex: tirar a cebola, ponto da carne, etc."></textarea>';
                optionsHtml += '</form>';
            }
            productDetailContent.innerHTML = `
                <img src="${p.img}" alt="${p.name}" class="product-detail-modal-img">
                <h2 class="product-detail-modal-title">${p.name}</h2>
                <p class="product-detail-modal-price">${money(p.price)}</p>
                <p class="product-detail-modal-desc">${p.desc}</p>
                ${optionsHtml} <br>
                <button id="addToCartFromDetail">Adicionar ao Carrinho</button>
                <button class="ghost" id="closeDetailModal">Voltar</button>`;
            productDetailModal.style.display = 'block';

            document.getElementById('addToCartFromDetail').addEventListener('click', () => {
                const selectedOptions = {};
                const form = document.getElementById('productOptionsForm');
                if (form) {
                    const protein = form.querySelector('input[name="protein"]:checked');
                    if (protein) selectedOptions.protein = protein.value;
                    const cutlery = form.querySelector('input[name="cutlery"]:checked');
                    if (cutlery) selectedOptions.cutlery = cutlery.value;
                    const observations = form.querySelector('#observations');
                    if (observations && observations.value.trim() !== '') selectedOptions.observations = observations.value.trim();
                }
                addToCart(id, selectedOptions);
                productDetailModal.style.display = 'none';
            });
            document.getElementById('closeDetailModal').addEventListener('click', () => { productDetailModal.style.display = 'none'; });
        }

        function addCardEventListeners() {
            document.querySelectorAll('[data-details]').forEach(card => card.addEventListener('click', e => {
                const id = +e.currentTarget.dataset.details;
                const product = products.find(p => p.id === id);
                if (!product.options && !product.isCombo) {
                    addToCart(id);
                } else {
                    showProductDetail(id);
                }
            }));
        }

        function addToCart(productId, options = {}) {
            const product = products.find(p => p.id === productId);
            const optionsKey = JSON.stringify(options);
            const existingItem = cart.find(item => item.productId === productId && JSON.stringify(item.options) === optionsKey);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                const cartItemId = Date.now().toString() + Math.random();
                cart.push({ cartItemId, productId, quantity: 1, options, name: product.name, price: product.price });
            }
            updateCartUI();
        }

        function removeFromCart(cartItemId) {
            const itemIndex = cart.findIndex(item => item.cartItemId === cartItemId);
            if (itemIndex > -1) {
                cart[itemIndex].quantity--;
                if (cart[itemIndex].quantity <= 0) cart.splice(itemIndex, 1);
            }
            updateCartUI();
        }

        function updateCartUI() {
            const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalValue = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartFloat.style.display = totalCount > 0 ? 'flex' : 'none';
            cartCount.textContent = totalCount;
            cartTotal.textContent = money(totalValue);
            cartItems.innerHTML = '';
            cart.forEach(item => {
                let optionsText = Object.entries(item.options).map(([key, value]) => `<strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}`).join('<br>');
                const row = document.createElement('div');
                row.className = 'cart-row';
                row.innerHTML = `<div class="cart-row-main"><span>${item.name} x ${item.quantity}</span><span>${money(item.price * item.quantity)} <button class='ghost' data-rem='${item.cartItemId}'>-</button></span></div>${optionsText ? `<div class="cart-row-options">${optionsText}</div>` : ''}`;
                cartItems.appendChild(row);
            });
            document.querySelectorAll('[data-rem]').forEach(b => b.addEventListener('click', e => { removeFromCart(e.currentTarget.dataset.rem); }));
            localStorage.setItem('lumixCart', JSON.stringify(cart));
        }

        function loadCart() {
            const savedCart = localStorage.getItem('lumixCart');
            if (savedCart) cart = JSON.parse(savedCart);
        }

        function setupEventListeners() {
            categoryFilters.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const selectedCategory = e.target.dataset.category;
                    categoryFilters.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderCatalog(searchBar.value, selectedCategory);
                }
            });

            searchBar.addEventListener('input', () => {
                const activeCategoryBtn = categoryFilters.querySelector('button.active');
                const selectedCategory = activeCategoryBtn ? activeCategoryBtn.dataset.category : 'todos';
                renderCatalog(searchBar.value, selectedCategory);
            });

            openCart.addEventListener('click', () => { cartModal.style.display = 'block'; });
            closeCart.addEventListener('click', () => { cartModal.style.display = 'none'; });
            productDetailModal.addEventListener('click', (e) => { if (e.target === productDetailModal) productDetailModal.style.display = 'none'; });
            
            orderWhats.addEventListener('click', () => {
                const phone = '+5562999998888'; // **RECUERDA CAMBIAR ESTE N√öMERO**
                let lines = ['*Ol√° LUMIX ARTIFICIAL! ü§ñ Gostaria de fazer um pedido:*\n'];
                cart.forEach(item => {
                    lines.push(`- ${item.quantity}x ${item.name}`);
                    let optionsText = Object.entries(item.options).map(([key, value]) => `  - ${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`).join('\n');
                    if (optionsText) lines.push(optionsText);
                });
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                lines.push('\n*Total estimado: ' + money(total) + '*');
                const text = encodeURIComponent(lines.join('\n'));
                const base = 'https://wa.me/' + phone.replace(/\+/g, '');
                window.open(base + '?text=' + text, '_blank');
            });
        }
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('Service Worker registrado com sucesso.', reg);
                    notificationsBtn.addEventListener('click', () => {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                notificationsBtn.classList.add('active');
                                new Notification('LUMIX ARTIFICIAL', { body: 'Pronto! Agora voc√™ receber√° nossas novidades e promo√ß√µes.' });
                            }
                        });
                    });
                }).catch(err => console.error('Falha ao registrar Service Worker:', err));
            }
        }
        
        // --- INICIALIZACI√ìN DE LA APP ---
        function init() {
            loadCart();
            renderFeatured();
            renderCategories();
            renderCatalog();
            updateCartUI();
            setupEventListeners();
            registerServiceWorker();
            // Activar el primer bot√≥n de categor√≠a
            const firstCategoryButton = categoryFilters.querySelector('button');
            if(firstCategoryButton) firstCategoryButton.classList.add('active');
        }

        init();
    });
</script>
</body>
</html>


